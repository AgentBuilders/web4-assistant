<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multivac</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéõÔ∏è</text></svg>">
  <script
    async
    src="https://ga.jspm.io/npm:es-module-shims@2.0.10/dist/es-module-shims.js"
    crossorigin="anonymous"
  ></script>
  <script type="importmap">
    {
      "imports": {
        "@near-wallet-selector/core": "https://ga.jspm.io/npm:@near-wallet-selector/core@8.10.0/index.js",
        "@near-wallet-selector/modal-ui-js": "https://ga.jspm.io/npm:@near-wallet-selector/modal-ui-js@8.10.0/index.js",
        "@near-wallet-selector/my-near-wallet": "https://ga.jspm.io/npm:@near-wallet-selector/my-near-wallet@8.10.0/index.js",
        "buffer": "https://ga.jspm.io/npm:buffer@6.0.3/index.js",
        "marked": "https://ga.jspm.io/npm:marked@15.0.7/lib/marked.esm.js",
        "near-api-js": "https://ga.jspm.io/npm:near-api-js@4.0.4/lib/browser-index.js"
      },
      "scopes": {
        "./": {
          "@near-wallet-selector/ledger": "https://ga.jspm.io/npm:@near-wallet-selector/ledger@8.9.15/index.js"
        },
        "https://ga.jspm.io/": {
          "@ledgerhq/devices": "https://ga.jspm.io/npm:@ledgerhq/devices@8.4.4/lib-es/index.js",
          "@ledgerhq/devices/hid-framing": "https://ga.jspm.io/npm:@ledgerhq/devices@8.4.4/lib-es/hid-framing.js",
          "@ledgerhq/errors": "https://ga.jspm.io/npm:@ledgerhq/errors@6.19.1/lib-es/index.js",
          "@ledgerhq/hw-transport": "https://ga.jspm.io/npm:@ledgerhq/hw-transport@6.31.4/lib-es/Transport.js",
          "@ledgerhq/hw-transport-webhid": "https://ga.jspm.io/npm:@ledgerhq/hw-transport-webhid@6.29.4/lib-es/TransportWebHID.js",
          "@ledgerhq/logs": "https://ga.jspm.io/npm:@ledgerhq/logs@6.12.0/lib-es/index.js",
          "@near-js/accounts": "https://ga.jspm.io/npm:@near-js/accounts@1.2.1/lib/index.js",
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/lib/index.js",
          "@near-js/keystores": "https://ga.jspm.io/npm:@near-js/keystores@0.0.12/lib/index.js",
          "@near-js/keystores-browser": "https://ga.jspm.io/npm:@near-js/keystores-browser@0.0.12/lib/index.js",
          "@near-js/providers": "https://ga.jspm.io/npm:@near-js/providers@0.2.2/lib/index.js",
          "@near-js/signers": "https://ga.jspm.io/npm:@near-js/signers@0.1.4/lib/index.js",
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.2/lib/index.js",
          "@near-js/types": "https://ga.jspm.io/npm:@near-js/types@0.2.1/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.2.2/lib/index.js",
          "@near-js/wallet-account": "https://ga.jspm.io/npm:@near-js/wallet-account@1.2.2/lib/index.js",
          "@near-wallet-selector/core": "https://ga.jspm.io/npm:@near-wallet-selector/core@8.9.15/index.js",
          "@near-wallet-selector/wallet-utils": "https://ga.jspm.io/npm:@near-wallet-selector/wallet-utils@8.9.15/index.js",
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/ed25519.js",
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/crypto.js",
          "@noble/hashes/sha256": "https://ga.jspm.io/npm:@noble/hashes@1.3.3/sha256.js",
          "@noble/hashes/sha512": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/sha512.js",
          "@noble/hashes/utils": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/utils.js",
          "base-x": "https://ga.jspm.io/npm:base-x@2.0.6/index.js",
          "base64-js": "https://ga.jspm.io/npm:base64-js@1.5.1/index.js",
          "bn.js": "https://ga.jspm.io/npm:bn.js@4.12.1/lib/bn.js",
          "borsh": "https://ga.jspm.io/npm:borsh@1.0.0/lib/cjs/index.js",
          "brorand": "https://ga.jspm.io/npm:brorand@1.1.0/index.js",
          "bs58": "https://ga.jspm.io/npm:bs58@4.0.0/index.js",
          "buffer": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/buffer.js",
          "copy-to-clipboard": "https://ga.jspm.io/npm:copy-to-clipboard@3.3.3/index.js",
          "crypto": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/crypto.js",
          "depd": "https://ga.jspm.io/npm:depd@2.0.0/lib/browser/index.js",
          "dijkstrajs": "https://ga.jspm.io/npm:dijkstrajs@1.0.3/dijkstra.js",
          "elliptic": "https://ga.jspm.io/npm:elliptic@6.6.1/lib/dev.elliptic.js",
          "events": "https://ga.jspm.io/npm:events@3.3.0/events.js",
          "generate-function": "https://ga.jspm.io/npm:generate-function@2.3.1/index.js",
          "generate-object-property": "https://ga.jspm.io/npm:generate-object-property@1.2.0/index.js",
          "hash.js": "https://ga.jspm.io/npm:hash.js@1.1.7/lib/hash.js",
          "hmac-drbg": "https://ga.jspm.io/npm:hmac-drbg@1.0.1/lib/hmac-drbg.js",
          "http": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/http.js",
          "http-errors": "https://ga.jspm.io/npm:http-errors@1.7.2/index.js",
          "https": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/https.js",
          "ieee754": "https://ga.jspm.io/npm:ieee754@1.2.1/index.js",
          "inherits": "https://ga.jspm.io/npm:inherits@2.0.4/inherits_browser.js",
          "is-mobile": "https://ga.jspm.io/npm:is-mobile@4.0.0/index.js",
          "is-my-ip-valid": "https://ga.jspm.io/npm:is-my-ip-valid@1.0.1/index.js",
          "is-my-json-valid": "https://ga.jspm.io/npm:is-my-json-valid@2.20.6/index.js",
          "is-property": "https://ga.jspm.io/npm:is-property@1.0.2/is-property.js",
          "js-sha256": "https://ga.jspm.io/npm:js-sha256@0.9.0/src/sha256.js",
          "jsonpointer": "https://ga.jspm.io/npm:jsonpointer@5.0.1/jsonpointer.js",
          "lru_map": "https://ga.jspm.io/npm:lru_map@0.4.1/dist/lru.js",
          "minimalistic-assert": "https://ga.jspm.io/npm:minimalistic-assert@1.0.1/index.js",
          "minimalistic-crypto-utils": "https://ga.jspm.io/npm:minimalistic-crypto-utils@1.0.1/lib/utils.js",
          "mustache": "https://ga.jspm.io/npm:mustache@4.0.0/mustache.js",
          "near-abi": "https://ga.jspm.io/npm:near-abi@0.1.1/lib/index.js",
          "near-api-js": "https://ga.jspm.io/npm:near-api-js@4.0.3/lib/browser-index.js",
          "near-api-js/lib/providers": "https://ga.jspm.io/npm:near-api-js@4.0.3/lib/providers/index.js",
          "node-fetch": "https://ga.jspm.io/npm:node-fetch@2.6.7/browser.js",
          "process": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/process.js",
          "qrcode": "https://ga.jspm.io/npm:qrcode@1.5.4/lib/browser.js",
          "randombytes": "https://ga.jspm.io/npm:randombytes@2.1.0/browser.js",
          "rxjs": "https://ga.jspm.io/npm:rxjs@7.8.1/dist/esm5/index.js",
          "safe-buffer": "https://ga.jspm.io/npm:safe-buffer@5.2.1/index.js",
          "secp256k1": "https://ga.jspm.io/npm:secp256k1@5.0.0/elliptic.js",
          "semver": "https://ga.jspm.io/npm:semver@7.7.1/index.js",
          "setprototypeof": "https://ga.jspm.io/npm:setprototypeof@1.1.1/index.js",
          "statuses": "https://ga.jspm.io/npm:statuses@1.5.0/dev.index.js",
          "toggle-selection": "https://ga.jspm.io/npm:toggle-selection@1.0.6/index.js",
          "toidentifier": "https://ga.jspm.io/npm:toidentifier@1.0.0/index.js",
          "tslib": "https://ga.jspm.io/npm:tslib@2.8.1/tslib.es6.mjs",
          "util": "https://ga.jspm.io/npm:@jspm/core@2.1.0/nodelibs/browser/util.js",
          "xtend": "https://ga.jspm.io/npm:xtend@4.0.2/immutable.js"
        },
        "https://ga.jspm.io/npm:@near-js/accounts@1.2.2/": {
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js",
          "@near-js/providers": "https://ga.jspm.io/npm:@near-js/providers@0.2.3/lib/index.js",
          "@near-js/signers": "https://ga.jspm.io/npm:@near-js/signers@0.1.5/lib/index.js",
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.3/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/_/HcaMPL-t.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/_/LX1h3mee.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/": {
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/_/CDDWVrU4.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/_/CX9hRabg.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@near-js/keystores-browser@0.1.0/": {
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js",
          "@near-js/keystores": "https://ga.jspm.io/npm:@near-js/keystores@0.1.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/keystores@0.1.0/": {
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/providers@0.2.3/": {
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.3/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/signers@0.1.5/": {
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js",
          "@near-js/keystores": "https://ga.jspm.io/npm:@near-js/keystores@0.1.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/transactions@1.2.3/": {
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-js/wallet-account@1.2.3/": {
          "@near-js/accounts": "https://ga.jspm.io/npm:@near-js/accounts@1.2.2/lib/index.js",
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js",
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.3/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.3.0/lib/index.js"
        },
        "https://ga.jspm.io/npm:@near-wallet-selector/core@8.10.0/": {
          "borsh": "https://ga.jspm.io/npm:borsh@1.0.0/lib/esm/index.js"
        },
        "https://ga.jspm.io/npm:@near-wallet-selector/core@8.9.15/": {
          "borsh": "https://ga.jspm.io/npm:borsh@1.0.0/lib/esm/index.js"
        },
        "https://ga.jspm.io/npm:@near-wallet-selector/my-near-wallet@8.10.0/": {
          "@near-wallet-selector/wallet-utils": "https://ga.jspm.io/npm:@near-wallet-selector/wallet-utils@8.10.0/index.js"
        },
        "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js": {
          "@noble/hashes/sha512": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/sha512.js",
          "@noble/hashes/utils": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/utils.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/_sha2.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/sha512.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/utils.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.3/": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.3/crypto.js"
        },
        "https://ga.jspm.io/npm:http-errors@1.7.2/": {
          "depd": "https://ga.jspm.io/npm:depd@1.1.2/lib/browser/index.js",
          "inherits": "https://ga.jspm.io/npm:inherits@2.0.3/inherits_browser.js"
        },
        "https://ga.jspm.io/npm:near-api-js@4.0.4/": {
          "@near-js/accounts": "https://ga.jspm.io/npm:@near-js/accounts@1.2.2/lib/index.js",
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.3.0/lib/index.js",
          "@near-js/keystores": "https://ga.jspm.io/npm:@near-js/keystores@0.1.0/lib/index.js",
          "@near-js/keystores-browser": "https://ga.jspm.io/npm:@near-js/keystores-browser@0.1.0/lib/index.js",
          "@near-js/providers": "https://ga.jspm.io/npm:@near-js/providers@0.2.3/lib/index.js",
          "@near-js/signers": "https://ga.jspm.io/npm:@near-js/signers@0.1.5/lib/index.js",
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.3/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.3.0/lib/index.js",
          "@near-js/wallet-account": "https://ga.jspm.io/npm:@near-js/wallet-account@1.2.3/lib/index.js"
        }
      }
    }
  </script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/@near-wallet-selector/modal-ui@8.10.0/styles.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Multivac</h1>
    <button id="connectWallet" class="btn btn-primary">Connect NEAR Wallet</button>
    <p  class="m-2" id="accountInfo">‚ùå NOT CONNECTED</p>
    <hr />
    <div class="mt-4" id="editorSection" style="display: none;">
      <h3>Customize Your Web4 Page</h3>
      <div class="mb-3">
        <label for="htmlContent" class="form-label">Edit HTML</label>
        <textarea id="htmlContent" class="form-control" rows="10" placeholder="Edit your HTML here"></textarea>
      </div>
      <div class="mb-3">
        <button class="btn btn-secondary" id="resetButton" style="display:none;">Reset</button>
        <button class="btn btn-success" id="publishButton">Publish</button>
      </div>
      <div id="previewContainer" class="mb-3" style="display: none;">
        <h5>Live Preview</h5>
        <p id="publishStatus" class="mt-2 fw-bold"></p>
        <iframe id="previewFrame" style="width: 100%; height: 400px; border: 1px solid #ccc;"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { setupWalletSelector } from "@near-wallet-selector/core";
    import { setupModal } from "@near-wallet-selector/modal-ui-js";
    import { setupMyNearWallet } from "@near-wallet-selector/my-near-wallet";
    import { Buffer } from "buffer";
    import { connect } from "near-api-js";

    const contractId = "multivac.testnet";
    const networkId = "testnet";
    let connectedAccountId = null;
    let walletSelector;

    window.Buffer = Buffer;

    async function initWallet() {
      walletSelector = await setupWalletSelector({
        network: networkId,
        modules: [setupMyNearWallet()],
      });

      const modal = setupModal(walletSelector, {
        contractId,
        theme: "light",
        description: "Connect to edit your Web4 page",
      });

      const connectWalletButton = document.getElementById("connectWallet");

      if (walletSelector.isSignedIn()) {
        const wallet = await walletSelector.wallet();
        const account = (await wallet.getAccounts())[0];
        connectedAccountId = account.accountId;
        fetchCurrentContent();

        document.getElementById("accountInfo").innerText = `‚úîÔ∏è Connected: ${connectedAccountId}`;

        connectWalletButton.innerText = "Disconnect";
        connectWalletButton.classList.remove("btn-primary");
        connectWalletButton.classList.add("btn-warning");

        connectWalletButton.onclick = async () => {
          await wallet.signOut();

          connectedAccountId = null;
          document.getElementById("accountInfo").innerText = "‚ùå NOT CONNECTED";
          document.getElementById("editorSection").style.display = "none";
          document.getElementById("publishStatus").innerHTML = "";
          document.getElementById("previewContainer").style.display = "none";

          connectWalletButton.innerText = "Connect NEAR Wallet";
          connectWalletButton.classList.remove("btn-warning");
          connectWalletButton.classList.add("btn-primary");

          connectWalletButton.onclick = () => modal.show();
        };
      } else {
        connectWalletButton.innerText = "Connect NEAR Wallet";
        connectWalletButton.classList.remove("btn-warning");
        connectWalletButton.classList.add("btn-primary");
        connectWalletButton.onclick = () => modal.show();
      }

      if (walletSelector.isSignedIn()) {
        document.getElementById("editorSection").style.display = "block";
      }
    }

    let originalHtml = '';

    async function fetchCurrentContent() {
      try {
        const response = await fetch(`https://multivac.testnet.page/${connectedAccountId}`);
        if (response.ok) {
          const data = await response.text();
          document.getElementById("htmlContent").value = data || "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";
          originalHtml = data || "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";

          document.getElementById("previewFrame").srcdoc = originalHtml;
          document.getElementById("previewContainer").style.display = "block";
          toggleResetButton(false);
        } else {
          document.getElementById("publishStatus").innerHTML = "‚ö†Ô∏è Content not found for this account.";
          document.getElementById("htmlContent").value = "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";
          originalHtml = "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";

          document.getElementById("previewFrame").srcdoc = originalHtml;
          document.getElementById("previewContainer").style.display = "block";
          toggleResetButton(false);
        }
      } catch (error) {
        console.error("Error fetching current content:", error);
        document.getElementById("publishStatus").innerHTML = "‚ö†Ô∏è Unable to fetch current content.";
        document.getElementById("htmlContent").value = "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";
        originalHtml = "<h1>Welcome to WebForge!</h1><p>Edit your page content here.</p>";

        document.getElementById("previewFrame").srcdoc = originalHtml;
        document.getElementById("previewContainer").style.display = "block";
        toggleResetButton(false);
      }
    }

    document.getElementById("htmlContent").addEventListener("input", () => {
      const currentHtml = document.getElementById("htmlContent").value.trim();

      if (currentHtml !== originalHtml) {
        toggleResetButton(true);
      } else {
        toggleResetButton(false);
      }

      document.getElementById("previewFrame").srcdoc = currentHtml;
      document.getElementById("previewContainer").style.display = "block";
    });

    document.getElementById("resetButton").onclick = function () {
      document.getElementById("htmlContent").value = originalHtml;
      document.getElementById("previewFrame").srcdoc = originalHtml;
      toggleResetButton(false);
    }

    function toggleResetButton(show) {
      const resetButton = document.getElementById("resetButton");
      if (show) {
        resetButton.style.display = "inline-block";
      } else {
        resetButton.style.display = "none";
      }
    }

    document.getElementById("publishButton").onclick = async () => {
      if (!connectedAccountId || !walletSelector.isSignedIn()) return;

      const htmlContent = document.getElementById("htmlContent").value.trim() || "<h1>My Web4 Page</h1>";
      const encodedHtml = btoa(unescape(encodeURIComponent(htmlContent)));

      const wallet = await walletSelector.wallet();
      const result = await wallet.signAndSendTransaction({
        receiverId: contractId,
        actions: [
          {
            type: "FunctionCall",
            params: {
              methodName: "post_content",
              args: {
                key: `/${connectedAccountId}`,
                valuebase64: encodedHtml,
              },
              gas: "100000000000000",
              deposit: "0",
            },
          },
        ],
      });

      document.getElementById("publishStatus").innerHTML = `
        üéâ Page published at <a href="https://${contractId}.page/${connectedAccountId}" target="_blank" rel="noopener noreferrer">${contractId}.page/${connectedAccountId}</a>
      `;
      console.log("post_content result", result);
    };

    initWallet();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
